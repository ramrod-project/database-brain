sudo: required

language: python

python:
  - "3.6"

services:
- docker

branches:
  only:
  - master
  - dev
  - qa

# command to install dependencies
install:
  - pip install -r requirements.txt
  - pip install pytest-cov
  - if [ "$TRAVIS_BRANCH" == "master"  ]; 
    then travis_wait 10 docker pull ramrodpcp/database-brain:latest; 
    else travis_wait 10 docker pull ramrodpcp/database-brain:$TRAVIS_BRANCH; fi
  - if [ "$TRAVIS_BRANCH" != "master"  ];
    then docker build -t ramrodpcp/database-brain:$TRAVIS_BRANCH . ;
    else docker build -t ramrodpcp/database-brain:latest . ;
    fi
  - curl -L https://codeclimate.com/downloads/test-reporter/test-reporter-latest-linux-amd64 > ./cc-test-reporter
  - chmod +x ./cc-test-reporter
  - ./cc-test-reporter before-build

before_script:
  - pytest --cov --cov-config .coveragerc --cov-report xml schema/test_sample.py setup/test_integration.py test/
  - ./cc-test-reporter after-build -t coverage.py --exit-code 0

script:
  - if [ "$TRAVIS_BRANCH" != "master"  ];
    then docker run -d --rm --name Brain -e "STAGE=DEV" -e "LOGLEVEL=DEBUG" -v /var/run/docker.sock:/var/run/docker.sock ramrodpcp/database-brain:$TRAVIS_BRANCH ;
    else docker run -d --rm --name Brain -e "STAGE=PROD" -e "LOGLEVEL=CRITICAL" -v /var/run/docker.sock:/var/run/docker.sock ramrodpcp/database-brain:latest ;
    fi
  - sleep 30
  - docker ps
  - docker logs Brain
  - docker stop Brain

after_success:
  - if [[ "$TRAVIS_PULL_REQUEST" == "false" ]]; 
    then echo "$DOCKER_PASSWORD" | docker login -u "$DOCKER_USERNAME" --password-stdin; fi
  - if [[ "$TRAVIS_BRANCH" == "master" && "$TRAVIS_PULL_REQUEST" == "false" ]]; 
    then docker push ramrodpcp/database-brain:latest;
    elif [[ "$TRAVIS_PULL_REQUEST" == "false" ]]; 
    then docker push ramrodpcp/database-brain:$TRAVIS_BRANCH; fi


slack: ramrod-project:GDF82rRYDg3KSekrT3GA24qO
